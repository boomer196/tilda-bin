#!/usr/bin/env ruby

# Borrowed from Jim Garvin, but modified over the years
# http://github.com/coderifous/dotfiles/blob/master/bin/git-stats.rb

require "shellwords"

format = "%24s %10s %10s %12s %12s %12s\n"
printf(format, *%w(author commits touches inserts deletes net))
puts "-" * 86

authors = []
open("| git shortlog -sn --no-merges").each do |line|
  authors << line.sub(/^\s*\d+\s*/, '').chomp
end

total_commits = total_touches = total_inserts = total_deletes = 0
authors.each do |name|
  author_commits = author_touches = author_inserts = author_deletes = 0
  open("| git log --shortstat --no-merges --author=#{name.shellescape} | grep -E 'files? changed'").each do |line|
    touches = line.match(/(\d+) files? changed/)
    inserts = line.match(/(\d+) insertion/)
    deletes = line.match(/(\d+) deletion/)
    author_commits += 1               if touches
    author_touches += touches[1].to_i if touches
    author_inserts += inserts[1].to_i if inserts
    author_deletes += deletes[1].to_i if deletes
  end

  printf(format, name, author_commits, author_touches, author_inserts, -1 * author_deletes, author_inserts - author_deletes)

  total_commits += author_commits
  total_touches += author_touches
  total_inserts += author_inserts
  total_deletes += author_deletes
end

puts "-" * 86
printf(format, authors.size, total_commits, total_touches, total_inserts, -1 * total_deletes, total_inserts - total_deletes)
